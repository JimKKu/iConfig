#!/bin/bash

# ========== ç”¨æˆ·é…ç½®åŒºåŸŸ ==========
# ä½¿ç”¨æ ‡å‡†çš„Bashæ•°ç»„è¯­æ³•ï¼ˆæ³¨æ„ï¼šæ–¹æ‹¬å·ä»…ç”¨äºæ³¨é‡Šï¼‰
PATHS=(               # æ­¤å¤„åº”ä¸ºåœ†æ‹¬å·
    "$HOME/.local/bin"
    # "$HOME/.local/bin" 
    # "/other/path"   # æ·»åŠ æ›´å¤šè·¯å¾„
)

TABLE_WIDTH=100       # è¡¨æ ¼åŸºå‡†å®½åº¦
CMD_COL_RATIO=30     # å‘½ä»¤åˆ—å®½åº¦å æ¯”
NO_COMMENT_TEXT="..." # æ— æ³¨é‡Šæ˜¾ç¤ºå†…å®¹

# è«å…°è¿ªé…è‰²æ–¹æ¡ˆ
# COLOR_TITLE='\033[38;5;111m'  # æ ‡é¢˜è‰²ï¼ˆé›¾è“ï¼‰
# COLOR_CMD='\033[38;5;153m'    # å‘½ä»¤è‰²ï¼ˆæµ…è“ï¼‰
# COLOR_DESC='\033[38;5;183m'   # æè¿°è‰²ï¼ˆé¦™èŠ‹ç´«ï¼‰
# COLOR_BORDER='\033[38;5;103m' # è¾¹æ¡†è‰²ï¼ˆç°ç»¿ï¼‰
# COLOR_RESET='\033[0m'
# ================================

# æ–¹æ¡ˆ2ï¼šè–„è·æ¸…æ™¨
# COLOR_TITLE='\033[38;5;115m'  # è–„è·ç»¿
# COLOR_CMD='\033[38;5;195m'    # é›ªç™½è‰²
# COLOR_DESC='\033[38;5;158m'   # æµ…æ°´è“
# COLOR_BORDER='\033[38;5;108m' # æ¾çŸ³ç»¿

# æ–¹æ¡ˆ3ï¼šæ¨±èŠ±ç²‰ç´«
COLOR_TITLE='\033[38;5;183m'  # æµ…ç´«è‰²
COLOR_CMD='\033[38;5;225m'    # æ¨±èŠ±ç²‰
COLOR_DESC='\033[38;5;189m'   # è–°è¡£è‰ç´«
COLOR_BORDER='\033[38;5;139m' # ç´«è—¤è‰²
#
# æ–¹æ¡ˆ4ï¼šèŒ¶è‰²æš–è°ƒ
# COLOR_TITLE='\033[38;5;180m'  # æµ…é©¼è‰²
# COLOR_CMD='\033[38;5;223m'    # ç±³ç™½è‰²
# COLOR_DESC='\033[38;5;144m'   # äºšéº»è‰²
# COLOR_BORDER='\033[38;5;101m' # å¡å…¶è‰²

# æ–¹æ¡ˆ5ï¼šæ¹–æ°´è“ç»¿
# COLOR_TITLE='\033[38;5;73m'   # å­”é›€çŸ³ç»¿
# COLOR_CMD='\033[38;5;122m'    # æ¹–æ°´è“
# COLOR_DESC='\033[38;5;158m'   # æµ…æ°´ç»¿
# COLOR_BORDER='\033[38;5;66m'  # æ·±é’ç°

# æ–¹æ¡ˆ6ï¼šæ¸…æ™¨ç°è°ƒ
# COLOR_TITLE='\033[38;5;145m'  # é¸½å­ç°
# COLOR_CMD='\033[38;5;255m'    # çº¯ç™½è‰²
# COLOR_DESC='\033[38;5;188m'   # çç ç°
# COLOR_BORDER='\033[38;5;102m' # æ°´æ³¥ç°

# æ–¹æ¡ˆ7ï¼šä¸é¦™æ·¡ç´«
# COLOR_TITLE='\033[38;5;189m'  # ä¸é¦™ç´«
# COLOR_CMD='\033[38;5;225m'    # æ·¡ç²‰ç´«
# COLOR_DESC='\033[38;5;183m'   # è–°è¡£è‰
# COLOR_BORDER='\033[38;5;139m' # ç´«æ°´æ™¶

# æ–¹æ¡ˆ8ï¼šæ²™æ»©æš–é»„
# COLOR_TITLE='\033[38;5;223m'  # æµ…ç±³é»„
# COLOR_CMD='\033[38;5;230m'    # è±¡ç‰™ç™½
# COLOR_DESC='\033[38;5;179m'   # æ²™é‡‘è‰²
# COLOR_BORDER='\033[38;5;137m' # é™¶åœŸè‰²
# ========================

# æ³¨é‡Šæå–å‡½æ•°
extract_comment() {
    grep -m1 "^##-- " "$1" 2>/dev/null | sed -E '
        s/^##--[[:space:]]*//;
        s/[[:space:]]+$//;
        :a;N;$!ba;s/\n/ â /g
    ' | tr -s ' ' || echo "$NO_COMMENT_TEXT"
}

# æ™ºèƒ½æˆªæ–­ç®—æ³•
smart_trunc() {
    local str=$1 max=$2 len=0 result=""
    for ((i=0; i<${#str}; i++)); do
        char=${str:i:1}
        char_width=$([[ $char =~ [^[:ascii:]] ]] && echo 2 || echo 1)
        ((len + char_width > max)) && break
        result+="$char"
        len=$((len + char_width))
    done
    ((i < ${#str})) && result+="..."
    echo "$result"
}

# ç»˜åˆ¶è¡¨æ ¼ç»„ä»¶
draw_table() {
    local path=$1
    local term_width=$(tput cols)
    local final_width=$(( TABLE_WIDTH < term_width ? TABLE_WIDTH : term_width ))
    local cmd_width=$(( final_width * CMD_COL_RATIO / 100 ))
    local desc_width=$(( final_width - cmd_width - 3 ))

    # è·¯å¾„æ ‡é¢˜ï¼ˆæ— è¾¹æ¡†ï¼‰
    echo -e "\n${COLOR_TITLE}ğŸ“‚ $path${COLOR_RESET}"
    
    # è¡¨æ ¼é¡¶éƒ¨è¾¹æ¡†
    echo -e "${COLOR_BORDER}â”Œ$(printf 'â”€%.0s' $(seq 1 $cmd_width))â”¬$(printf 'â”€%.0s' $(seq 1 $desc_width))â”"
    
    # è¡¨å¤´è¡Œ
    printf "${COLOR_BORDER}â”‚${COLOR_CMD}%-${cmd_width}s${COLOR_BORDER}â”‚${COLOR_DESC}%-${desc_width}s${COLOR_BORDER}â”‚\n" \
        " Command" " Description"
    
    # è¡¨å¤´åˆ†éš”çº¿
    echo -e "${COLOR_BORDER}â”œ$(printf 'â”€%.0s' $(seq 1 $cmd_width))â”¼$(printf 'â”€%.0s' $(seq 1 $desc_width))â”¤"

    # éå†å¯æ‰§è¡Œæ–‡ä»¶
    # find "$path" -maxdepth 1 -type f -executable -print | while read -r file; do
    find "$HOME/.local/bin" -type f -perm -111 2>/dev/null | while read -r file; do
        cmd=$(basename "$file")
        comment=$(extract_comment "$file")
        display_desc=$(smart_trunc "$comment" $desc_width)
        
        printf "${COLOR_BORDER}â”‚${COLOR_CMD}%-${cmd_width}s${COLOR_BORDER}â”‚${COLOR_DESC}%-${desc_width}s${COLOR_BORDER}â”‚\n" \
            " $cmd" " $display_desc"
    done

    # è¡¨æ ¼åº•éƒ¨
    echo -e "${COLOR_BORDER}â””$(printf 'â”€%.0s' $(seq 1 $cmd_width))â”´$(printf 'â”€%.0s' $(seq 1 $desc_width))â”˜${COLOR_RESET}"
}

# ä¸»ç¨‹åº
# clear
for path in "${PATHS[@]}"; do
    if [ -d "$path" ]; then
        draw_table "$path"
    else
        echo -e "${COLOR_TITLE}âš  è·¯å¾„ä¸å­˜åœ¨: $path${COLOR_RESET}"
    fi
done
